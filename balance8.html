<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„Éê„É©„É≥„ÇπÁ©ç„Åø‰∏ä„Åí„Ç≤„Éº„É†</title>
  <style>
    body {
      background: #eef;
      margin: 0;
      overflow: hidden;
      text-align: center;
      font-family: sans-serif;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="score">„Çπ„Ç≥„Ç¢: 0„ÄÄ„Éü„Çπ: 0/3</div>
  <canvas id="world"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <script>
    const { Engine, Render, World, Bodies, Runner, Body, Events } = Matter;

    const canvas = document.getElementById("world");
    const engine = Engine.create();
    const world = engine.world;
    const render = Render.create({
      canvas,
      engine,
      options: {
        width: window.innerWidth,
        height: window.innerHeight,
        wireframes: false,
        background: "#eef"
      }
    });

    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    const WIDTH = window.innerWidth;
    const HEIGHT = window.innerHeight;

    // Âú∞Èù¢
    const ground = Bodies.rectangle(WIDTH / 2, HEIGHT + 50, WIDTH, 100, { isStatic: true });
    World.add(world, ground);

    // Âèó„ÅëÁöøÔºàÂ§ß„Åç„Åè„Éª„ÇÜ„Å£„Åè„ÇäÔºâ
    const paddleWidth = 300;
    const paddleHeight = 20;
    const paddle = Bodies.rectangle(WIDTH / 2, HEIGHT - 100, paddleWidth, paddleHeight, {
      isStatic: true,
      render: { fillStyle: "#66c" }
    });
    World.add(world, paddle);

    let moveDirection = 1;
    const moveSpeed = 2; // „ÇÜ„Å£„Åè„ÇäÂãï„Åè

    // „Çπ„Ç≥„Ç¢„Å®„Éü„ÇπÂõûÊï∞
    let score = 0;
    let misses = 0;
    const maxMisses = 3;
    let gameOver = false;

    // „É©„É≥„ÉÄ„É†„Å™ÂΩ¢„Çí‰Ωú„ÇãÈñ¢Êï∞
    function createRandomShape(x, y) {
      const size = 40 + Math.random() * 20;
      const type = Math.floor(Math.random() * 3); // 0:ÂõõËßí, 1:‰∏∏, 2:‰∏âËßí
      let body;

      const color = `hsl(${Math.random() * 360}, 70%, 60%)`;

      if (type === 0) {
        body = Bodies.rectangle(x, y, size, size, { restitution: 0.2, friction: 0.8, render: { fillStyle: color } });
      } else if (type === 1) {
        body = Bodies.circle(x, y, size / 2, { restitution: 0.2, friction: 0.8, render: { fillStyle: color } });
      } else {
        const half = size / 2;
        const triangle = Bodies.polygon(x, y, 3, half, { restitution: 0.2, friction: 0.8, render: { fillStyle: color } });
        body = triangle;
      }

      World.add(world, body);
      return body;
    }

    // „ÇØ„É™„ÉÉ„ÇØ„ÅßËêΩ„Å®„Åô
    window.addEventListener("click", (e) => {
      if (gameOver) return;
      const shape = createRandomShape(e.clientX, 50);
      shape.isFalling = true;
    });

    // ËêΩ„Å°„Åü„Çâ„Éü„Çπ„Ç´„Ç¶„É≥„Éà
    Events.on(engine, "afterUpdate", () => {
      // Âèó„ÅëÁöø„ÇíÂ∑¶Âè≥„Å´Âãï„Åã„Åô
      if (paddle.position.x > WIDTH - paddleWidth / 2 || paddle.position.x < paddleWidth / 2) {
        moveDirection *= -1;
      }
      Body.setPosition(paddle, { x: paddle.position.x + moveDirection * moveSpeed, y: paddle.position.y });

      // „Éü„ÇπÂà§ÂÆö
      world.bodies.forEach(body => {
        if (body.isFalling && body.position.y > HEIGHT) {
          World.remove(world, body);
          body.isFalling = false;
          misses++;
          document.getElementById("score").textContent = `„Çπ„Ç≥„Ç¢: ${score}„ÄÄ„Éü„Çπ: ${misses}/${maxMisses}`;
          if (misses >= maxMisses) {
            gameOver = true;
            alert("„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅüò¢");
          }
        }
      });
    });

    // Âèó„ÅëÁöø„Å´‰πó„Å£„Åü„Çâ„Çπ„Ç≥„Ç¢Âä†ÁÆó
    Events.on(engine, "collisionStart", (event) => {
      if (gameOver) return;
      event.pairs.forEach(pair => {
        if ((pair.bodyA === paddle && pair.bodyB.isFalling) ||
            (pair.bodyB === paddle && pair.bodyA.isFalling)) {
          score++;
          pair.bodyA.isFalling = false;
          pair.bodyB.isFalling = false;
          document.getElementById("score").textContent = `„Çπ„Ç≥„Ç¢: ${score}„ÄÄ„Éü„Çπ: ${misses}/${maxMisses}`;
        }
      });
    });
  </script>
</body>
</html>
